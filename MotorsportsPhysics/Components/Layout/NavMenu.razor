﻿  <header class="sticky top-0 z-20 w-full bg-background-light/80 backdrop-blur-sm" @attributes="AdditionalAttributes">
    <div class="container mx-auto flex items-center justify-between whitespace-nowrap border-b border-primary/20 px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex items-center gap-4 text-gray-800">
        <img src="/favicon.png" alt="Favicon" style="height: 28px; width: 32px; vertical-align: middle;" />
        <h1 class="text-xl font-bold tracking-tight">PitData Insights Physics</h1>
      </div>
      <nav class="hidden md:flex items-center gap-8">
        <a class="text-sm font-medium hover:text-primary transition-colors" href="/race-menu">Race</a>
        <a class="text-sm font-medium hover:text-primary transition-colors" href="/topics">Learn</a>
        <a class="text-sm font-medium hover:text-primary transition-colors" href="/leaderboard">Leaderboard</a>
        <a class="text-sm font-medium hover:text-primary transition-colors" href="#">Community</a>
      </nav>
      <div class="flex items-center gap-4 relative">
        <button class="flex items-center justify-center rounded-full h-10 w-10 bg-primary/20 hover:bg-primary/30 transition-colors"
                @onclick="ToggleUserMenu" title="Account">
                 <div class="h-10 w-10 rounded-full bg-cover bg-center" style='background-image:url("images/user.png")'></div>
        </button>


        @if (showUserMenu)
        {
          <!-- click-away overlay -->
          <button class="fixed inset-0 z-10 cursor-default" @onclick="CloseUserMenu" tabindex="-1" aria-hidden="true"></button>
          <!-- dropdown -->
          <div class="absolute right-0 top-12 z-20 w-56 rounded-lg border border-primary/20 bg-white dark:bg-background-dark shadow-xl">
            <div class="px-4 py-3">
              <p class="text-xs text-gray-500">Signed in as</p>
              <p class="mt-1 font-semibold">@DisplayName</p>
            </div>
          </div>
        }
      </div>
    </div>
  </header>

@code {
  @inject IHttpContextAccessor Http
  [Parameter(CaptureUnmatchedValues = true)]
  public Dictionary<string, object>? AdditionalAttributes { get; set; }

  private bool showUserMenu = false;
  private void ToggleUserMenu() => showUserMenu = !showUserMenu;
  private void CloseUserMenu() => showUserMenu = false;

  private string DisplayName
  {
    get
    {
      var user = Http.HttpContext?.User;
      if (user?.Identity?.IsAuthenticated != true) return "Guest";
      var given = user.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value;
      var surname = user.FindFirst(System.Security.Claims.ClaimTypes.Surname)?.Value;
      var name = user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value;
      var full = ($"{given} {surname}").Trim();
      if (!string.IsNullOrWhiteSpace(full)) return full;
      return string.IsNullOrWhiteSpace(name) ? "User" : name!;
    }
  }
}